<!doctype html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns="http://www.w3.org/1999/html"
      layout:decorate="~{layout.html}">
<head><title>Game Parameters</title>

    <script>
        function read_json_and_check_form() {
            const mode = sessionStorage.getItem('game_mode');
            // Always read the default file first, and OVERWRITE it with the values entered by the user.
            $.getJSON(window.location.origin + '/defaults/' + mode + '.json', function (json) {
                // gather all form data (in a hierarchy e.g. center_flags -> with_respawns -> base)
                check_form(json);
                //console.log(JSON.stringify(json));
                // now we have all data in json and post it to the rest endpoint
                post_rest('game/load', {'id': sessionStorage.getItem('gameid')}, json, function (xhttp) {
                    console.log('response: ' + xhttp.status);
                    // if status is good, we redirect to the active page
                    if (xhttp.status < 400) window.location.href = window.location.origin + '/ui/active/base?' + jQuery.param({'id': sessionStorage.getItem('gameid')});
                });
            });
            return false;
        }

        /**
         * we read the defaults from the server if no preloaded game_parameter is available.
         * @param mode - name of the game_mode
         */
        function load_defaults_if_necessary() {
            const mode = sessionStorage.getItem('game_mode');
            const game_parameters_string = sessionStorage.getItem('game_parameters');
            if (!game_parameters_string) {
                $.getJSON(window.location.origin + '/defaults/' + mode + '.json', function (json) {
                    preset_form(json);
                });
            } else {
                preset_form(JSON.parse(game_parameters_string));
            }
        }

        function preset_form(game_parameters){
            document.getElementById('comment').value = game_parameters.comment;
            preset_gamemode_form(game_parameters);
        }

        function check_form_base(json) {
            json.comment = $("#comment").val();
        }

        // https://stackoverflow.com/a/30800715
        function downloadGameModeAsJson() {
            const game_parameters_string = sessionStorage.getItem('game_parameters');
            if (!game_parameters_string) return;

            const mode = sessionStorage.getItem('game_mode');
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(game_parameters_string);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName + ".json");
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>

</head>
<body>

<section layout:fragment="content">

    <section layout:fragment="gamemode_header">
    </section>

    <hr/>
    <div class="row mb-2">
        <form class="needs-validation" onsubmit="return read_json_and_check_form()" id="params_form">
            <div class="col-md-auto">
                <label for="comment" class="form-label">Game description</label>
                <input type="text" class="form-control" value="vanilla" id="comment" required minlength="1"
                       maxlength="20"/>
                <small id="comment-help" class="form-text">Will be visible on the Spawn-Agent's LCD. 20 chars
                    only.</small>
            </div>

            <section layout:fragment="with_respawns">
            </section>

            <section layout:fragment="params">
            </section>

            <div class="col-md-auto">
                <button class="d-none" id="btn_submit_param" type="submit"></button>
            </div>
        </form>
    </div>

    <script>load_defaults_if_necessary()</script>

    <div class="row mt-4 mb-2">
        <div class="col-md-auto">
            <button class="btn btn-outline-success" type="button"
                    onclick="document.getElementById('btn_submit_param').click();"><span
                    class="bi bi-cloud-upload-fill">&nbsp;Send to server</span>
            </button>
        </div>
        <div class="col-md-auto">
            <button class="btn btn-outline-info" type="button"
                    onclick="downloadGameModeAsJson()"><span
                    class="bi bi-download">&nbsp;Download Game</span>
            </button>
        </div>
    </div>
</section>


</body>
</html>
